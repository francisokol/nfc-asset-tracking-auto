{% extends 'admin/layout.html' %}

{% block content %}
<div class="container">
    {% include 'admin/navbar.html' %}
</div>
<div class="row d-flex justify-content-center">
    <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            {% if category == 'loginsuccess' %}
              <div class="alert alert-info alert-dismissible fade show" role="alert">
                <strong>{{ message }}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>
</div>
<div class="container">
    <div class="row" id="dashboard-counters">
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-success d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Total Items</h5>
                <h4 class="text-white" id="total-items">{{ totalItems }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 101</h5>
                <h4 class="text-white" id="cth101-count">{{ cth101Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 102</h5>
                <h4 class="text-white" id="cth102-count">{{ cth102Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 103</h5>
                <h4 class="text-white" id="cth103-count">{{ cth103Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 104</h5>
                <h4 class="text-white" id="cth104-count">{{ cth104Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 105</h5>
                <h4 class="text-white" id="cth105-count">{{ cth105Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 106</h5>
                <h4 class="text-white" id="cth106-count">{{ cth106Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 110</h5>
                <h4 class="text-white" id="cth110-count">{{ cth110Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 111</h5>
                <h4 class="text-white" id="cth111-count">{{ cth111Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 112</h5>
                <h4 class="text-white" id="cth112-count">{{ cth112Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 113</h5>
                <h4 class="text-white" id="cth113-count">{{ cth113Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 201</h5>
                <h4 class="text-white" id="cth201-count">{{ cth201Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 202</h5>
                <h4 class="text-white" id="cth202-count">{{ cth202Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 203</h5>
                <h4 class="text-white" id="cth203-count">{{ cth203Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 204</h5>
                <h4 class="text-white" id="cth204-count">{{ cth204Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 205</h5>
                <h4 class="text-white" id="cth205-count">{{ cth205Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 206</h5>
                <h4 class="text-white" id="cth206-count">{{ cth206Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 207</h5>
                <h4 class="text-white" id="cth207-count">{{ cth207Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 208</h5>
                <h4 class="text-white" id="cth208-count">{{ cth208Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 209</h5>
                <h4 class="text-white" id="cth209-count">{{ cth209Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 210</h5>
                <h4 class="text-white" id="cth210-count">{{ cth210Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 211</h5>
                <h4 class="text-white" id="cth211-count">{{ cth211Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 212</h5>
                <h4 class="text-white" id="cth212-count">{{ cth212Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 213</h5>
                <h4 class="text-white" id="cth213-count">{{ cth213Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 214</h5>
                <h4 class="text-white" id="cth214-count">{{ cth214Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-danger d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Pending Items</h5>
                <h4 class="text-white" id="pending-count">{{ pendingCount }}</h4>
            </div>
        </div>
    </div>

    <!-- Logs Section -->
    <div class="my-4">
        <h5><b>Recent Movement Logs</b></h5>
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-bordered table-hover">
                <thead class="sticky-top bg-light">
                    <tr>
                        <th>ID</th>
                        <th>NFC ID</th>
                        <th>Asset</th>
                        <th>Moved From</th>
                        <th>Action</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody id="logs-table-body">
                    {% for log, asset_name in logs %}
                    <tr>
                        <td>{{ log.id }}</td>
                        <td>{{ log.nfc_id }}</td>
                        <td>{{ asset_name }}</td>
                        <td>{{ log.from_location }}</td>
                        <td>{{ log.action }}</td>
                        <td>{{ log.timestamp }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="d-flex justify-content-center my-4 gap-3 flex-wrap">
    <a href="{{ url_for('export_daily_logs') }}" class="btn btn-info"
       style="background-color: #2ec3f5; border-color: #add8e6; color: #000;">
        üìÑ Export Daily Logs to PDF
    </a>

    <form method="POST" action="{{ url_for('delete_logs') }}"
          onsubmit="return confirm('Are you sure you want to delete all logs?');">
        <button type="submit" class="btn btn-danger">
            üóëÔ∏è Delete All Logs
        </button>
    </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const evtSource = new EventSource('/admin/dashboard-stream');
    
    evtSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        
        // Update counters
        document.getElementById('total-items').textContent = data.totalItems;
        document.getElementById('cth101-count').textContent = data.cth101Count;
        document.getElementById('cth102-count').textContent = data.cth102Count;
        document.getElementById('cth103-count').textContent = data.cth103Count;
        document.getElementById('cth104-count').textContent = data.cth104Count;
        document.getElementById('cth105-count').textContent = data.cth105Count;
        document.getElementById('cth106-count').textContent = data.cth106Count;
        document.getElementById('cth110-count').textContent = data.cth110Count;
        document.getElementById('cth111-count').textContent = data.cth111Count;
        document.getElementById('cth112-count').textContent = data.cth112Count;
        document.getElementById('cth113-count').textContent = data.cth113Count;
        document.getElementById('cth201-count').textContent = data.cth201Count;
        document.getElementById('cth202-count').textContent = data.cth202Count;
        document.getElementById('cth203-count').textContent = data.cth203Count;
        document.getElementById('cth204-count').textContent = data.cth204Count;
        document.getElementById('cth205-count').textContent = data.cth205Count;
        document.getElementById('cth206-count').textContent = data.cth206Count;
        document.getElementById('cth207-count').textContent = data.cth207Count;
        document.getElementById('cth208-count').textContent = data.cth208Count;
        document.getElementById('cth209-count').textContent = data.cth209Count;
        document.getElementById('cth210-count').textContent = data.cth210Count;
        document.getElementById('cth211-count').textContent = data.cth211Count;
        document.getElementById('cth212-count').textContent = data.cth212Count;
        document.getElementById('cth213-count').textContent = data.cth213Count;
        document.getElementById('cth214-count').textContent = data.cth214Count;
        document.getElementById('pending-count').textContent = data.pendingCount;
        
        // Update logs table
        const logsTableBody = document.getElementById('logs-table-body');
        logsTableBody.innerHTML = '';
        
        data.logs.forEach(log => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${log.id}</td>
                <td>${log.nfc_id}</td>
                <td>${log.asset_name || 'Unknown'}</td>
                <td>${log.from_location || 'N/A'}</td>
                <td>${log.action}</td>
                <td>${log.timestamp}</td>
            `;
            logsTableBody.appendChild(row);
        });
    };
    
    evtSource.onerror = function(err) {
        console.error("EventSource failed:", err);
        evtSource.close();
    };
});
</script>
{% endblock %}
