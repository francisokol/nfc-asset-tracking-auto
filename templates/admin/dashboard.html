{% extends 'admin/layout.html' %}

{% block content %}
<div class="container">
    {% include 'admin/navbar.html' %}
</div>
<div class="row d-flex justify-content-center">
    <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            {% if category == 'loginsuccess' %}
              <div class="alert alert-info alert-dismissible fade show" role="alert">
                <strong>{{ message }}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-success d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Total Items</h5>
                <h4 class="text-white" data-count="total">{{ totalItems }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 101</h5>
                <h4 class="text-white" data-room="CTH101">{{ cth101Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 102</h5>
                <h4 class="text-white" data-room="CTH102">{{ cth102Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 103</h5>
                <h4 class="text-white" data-room="CTH103">{{ cth103Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 104</h5>
                <h4 class="text-white" data-room="CTH104">{{ cth104Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 105</h5>
                <h4 class="text-white" data-room="CTH105">{{ cth105Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 106</h5>
                <h4 class="text-white" data-room="CTH106">{{ cth106Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 110</h5>
                <h4 class="text-white" data-room="CTH110">{{ cth110Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 111</h5>
                <h4 class="text-white" data-room="CTH111">{{ cth111Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 112</h5>
                <h4 class="text-white" data-room="CTH112">{{ cth112Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 113</h5>
                <h4 class="text-white" data-room="CTH113">{{ cth113Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 201</h5>
                <h4 class="text-white" data-room="CTH201">{{ cth201Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 202</h5>
                <h4 class="text-white" data-room="CTH202">{{ cth202Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 203</h5>
                <h4 class="text-white" data-room="CTH203">{{ cth203Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 204</h5>
                <h4 class="text-white" data-room="CTH204">{{ cth204Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 205</h5>
                <h4 class="text-white" data-room="CTH205">{{ cth205Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 206</h5>
                <h4 class="text-white" data-room="CTH206">{{ cth206Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 207</h5>
                <h4 class="text-white" data-room="CTH207">{{ cth207Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 208</h5>
                <h4 class="text-white" data-room="CTH208">{{ cth208Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 209</h5>
                <h4 class="text-white" data-room="CTH209">{{ cth209Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 210</h5>
                <h4 class="text-white" data-room="CTH210">{{ cth210Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 211</h5>
                <h4 class="text-white" data-room="CTH211">{{ cth211Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 212</h5>
                <h4 class="text-white" data-room="CTH212">{{ cth212Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 213</h5>
                <h4 class="text-white" data-room="CTH213">{{ cth213Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-info d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Items in CTH 214</h5>
                <h4 class="text-white" data-room="CTH214">{{ cth214Count }}</h4>
            </div>
        </div>
        <div class="col-xl-4 my-2 col-lg-4 col-sm-12">
            <div class="bg-danger d-flex p-3 justify-content-between align-items-center rounded shadow">
                <h5 class="text-white">Pending Items</h5>
                <h4 class="text-white" data-count="pending">{{ pendingCount }}</h4>
            </div>
        </div>
    </div>

    <!-- Logs Section -->
    <div class="my-4">
        <h5><b>Recent Movement Logs</b></h5>
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>NFC ID</th>
                        <th>Asset</th>
                        <th>Moved From</th>
                        <th>Action</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody">
                    {% for log, asset_name in logs %}
                    <tr>
                        <td>{{ log.id }}</td>
                        <td>{{ log.nfc_id }}</td>
                        <td>{{ asset_name or 'Unknown' }}</td>
                        <td>{{ log.from_location or 'N/A' }}</td>
                        <td>{{ log.action }}</td>
                        <td>{{ log.timestamp }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="d-flex justify-content-center my-4 gap-3 flex-wrap">
    <a href="{{ url_for('export_daily_logs') }}" class="btn btn-info"
       style="background-color: #2ec3f5; border-color: #add8e6; color: #000;">
        üìÑ Export Daily Logs to PDF
    </a>

    <form method="POST" action="{{ url_for('delete_logs') }}"
          onsubmit="return confirm('Are you sure you want to delete all logs?');">
        <button type="submit" class="btn btn-danger">
            üóëÔ∏è Delete All Logs
        </button>
    </form>
    </div>

<script>
let lastLogId = 0;
let isPolling = true;

// Function to update room counts
function updateRoomCounts() {
    fetch('/admin/dashboard')
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Update all room counts
            const rooms = ['CTH101', 'CTH102', 'CTH103', 'CTH104', 'CTH105', 'CTH106', 
                         'CTH110', 'CTH111', 'CTH112', 'CTH113', 'CTH201', 'CTH202', 
                         'CTH203', 'CTH204', 'CTH205', 'CTH206', 'CTH207', 'CTH208', 
                         'CTH209', 'CTH210', 'CTH211', 'CTH212', 'CTH213', 'CTH214'];
            
            rooms.forEach(room => {
                const count = doc.querySelector(`[data-room="${room}"]`)?.textContent;
                if (count) {
                    document.querySelector(`[data-room="${room}"]`).textContent = count;
                }
            });
            
            // Update total and pending counts
            const totalCount = doc.querySelector('[data-count="total"]')?.textContent;
            const pendingCount = doc.querySelector('[data-count="pending"]')?.textContent;
            
            if (totalCount) document.querySelector('[data-count="total"]').textContent = totalCount;
            if (pendingCount) document.querySelector('[data-count="pending"]').textContent = pendingCount;
        })
        .catch(error => console.error('Error updating room counts:', error));
}

// Function to check for new logs
function checkNewLogs() {
    if (!isPolling) return;

    fetch(`/admin/get-recent-logs?last_id=${lastLogId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                if (data.logs.length > 0) {
                    const tbody = document.getElementById('logsTableBody');
                    if (!tbody) return;

                    // Update lastLogId
                    lastLogId = data.last_id;

                    // Add new logs
                    data.logs.forEach(log => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${log.id || ''}</td>
                            <td>${log.nfc_id || ''}</td>
                            <td>${log.item_name || 'Unknown'}</td>
                            <td>${log.from_location || 'N/A'}</td>
                            <td>${log.action || ''}</td>
                            <td>${log.timestamp || ''}</td>
                        `;
                        tbody.insertBefore(row, tbody.firstChild);
                    });

                    // Remove excess rows
                    while (tbody.children.length > 20) {
                        tbody.removeChild(tbody.lastChild);
                    }

                    // Update room counts
                    updateRoomCounts();
                }
            } else {
                console.error('Error fetching logs:', data.message);
            }
        })
        .catch(error => console.error('Error checking for new logs:', error))
        .finally(() => {
            // Schedule next check
            setTimeout(checkNewLogs, 1000);
        });
}

// Start polling
checkNewLogs();

// Update room counts every 5 seconds as a fallback
setInterval(updateRoomCounts, 5000);

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    isPolling = false;
});
</script>
{% endblock %}
